<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analítico</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #667eea;
            --ligth: #f8fafc;
        }
        
        .nav-link.active {
            background: var(--ligth);
            color: var(--primary);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-card {
            background: var(--ligth);
            color: var(--primary);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 2rem 0;
        }

        .filter-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hero-gradient {
            background: linear-gradient(90deg, #667eea, #baa6ce);
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-gray-50 font-sans">
    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600 text-lg">Cargando datos de la encuesta...</p>
        </div>
    </div>

    <!-- Error Screen -->
    <div id="error" class="fixed inset-0 bg-red-50 flex items-center justify-center z-50" style="display: none;">
        <div class="text-center p-8">
            <div class="text-red-500 text-6xl mb-4">⚠️</div>
            <h2 class="text-2xl font-bold text-red-700 mb-2">Error al cargar los datos</h2>
            <p id="error-message" class="text-red-600">No se pudo acceder a los datos. Usando datos de muestra.</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" style="display: none;">
        <!-- Navigation -->
        <nav class="bg-white shadow-lg sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <div class="text-2xl font-bold text-gray-800">Dashboard Analítico</div>
                    </div>
                    <div class="hidden md:flex space-x-1">
                        <button class="nav-link px-4 py-2 rounded-lg text-sm font-medium transition-colors active"
                            onclick="showSection('intro')">Introducción</button>
                        <button class="nav-link px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                            onclick="showSection('demographics')">Perfil Sociodemográfico</button>
                        <button class="nav-link px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                            onclick="showSection('participation')">Participación</button>
                        <button class="nav-link px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                            onclick="showSection('inclusion')">Inclusión</button>
                        <button class="nav-link px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                            onclick="showSection('impact')">Impacto</button>
                        <button class="nav-link px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                            onclick="showSection('barriers')">Barreras</button>
                    </div>
                    <div class="md:hidden">
                        <button id="mobile-menu-btn" class="text-gray-600 hover:text-gray-800">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="md:hidden bg-white shadow-lg" style="display: none;">
            <div class="px-4 py-2 space-y-1">
                <button class="block w-full text-left px-4 py-2 rounded-lg text-sm font-medium"
                    onclick="showSection('intro'); toggleMobileMenu()">Introducción</button>
                <button class="block w-full text-left px-4 py-2 rounded-lg text-sm font-medium"
                    onclick="showSection('demographics'); toggleMobileMenu()">Perfil Sociodemográfico</button>
                <button class="block w-full text-left px-4 py-2 rounded-lg text-sm font-medium"
                    onclick="showSection('participation'); toggleMobileMenu()">Participación</button>
                <button class="block w-full text-left px-4 py-2 rounded-lg text-sm font-medium"
                    onclick="showSection('inclusion'); toggleMobileMenu()">Inclusión</button>
                <button class="block w-full text-left px-4 py-2 rounded-lg text-sm font-medium"
                    onclick="showSection('impact'); toggleMobileMenu()">Impacto</button>
                <button class="block w-full text-left px-4 py-2 rounded-lg text-sm font-medium"
                    onclick="showSection('barriers'); toggleMobileMenu()">Barreras</button>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="bg-white border-b" style="color: var(--primary)">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div id="stats-container" class="grid grid-cols-2 md:grid-cols-5 gap-4" style="color: var(--primary)">
                    <!-- Stats will be populated here -->
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-section">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex flex-wrap gap-4 items-center justify-center">
                    <div class="flex items-center space-x-2">
                        <label class="text-white font-medium text-sm">Sector:</label>
                        <select id="sector-filter" class="px-3 py-1 rounded-lg border-0 text-sm">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-white font-medium text-sm">Experiencia:</label>
                        <select id="experience-filter" class="px-3 py-1 rounded-lg border-0 text-sm">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-white font-medium text-sm">Participación:</label>
                        <select id="participation-filter" class="px-3 py-1 rounded-lg border-0 text-sm">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <button onclick="clearFilters()"
                        class="bg-white text-pink-600 px-4 py-1 rounded-lg text-sm font-medium hover:bg-gray-100 transition-colors">
                        Limpiar Filtros
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-8">
            <!-- Introduction Section -->
            <section id="intro" class="section active">
                <div class="hero-gradient text-white rounded-2xl p-8 mb-8">
                    <div class="max-w-4xl mx-auto text-center">
                        <h1 class="text-4xl md:text-5xl font-bold mb-6">Análisis del impacto de las comunidades en Barcelona</h1>
                        <div class="grid md:grid-cols-3 gap-6 text-center mb-[20px]">
                            <div class="bg-white/10 rounded-xl p-6">
                                <div class="text-4xl mb-2">🎯</div>
                                <h3 class="font-semibold mb-2">Objetivo</h3>
                                <p class="text-sm opacity-80">Evaluar el impacto de las comunidades de mujeres en tecnología en Barcelona</p>
                            </div>
                            <div class="bg-white/10 rounded-xl p-6">
                                <div class="text-4xl mb-2">📊</div>
                                <h3 class="font-semibold mb-2">Metodología</h3>
                                <p class="text-sm opacity-80">Encuesta dirigida a profesionales del sector tecnológico</p>
                            </div>
                            <div class="bg-white/10 rounded-xl p-6">
                                <div class="text-4xl mb-2">🌍</div>
                                <h3 class="font-semibold mb-2">ODS</h3>
                                <p class="text-sm opacity-80">Contribución a los Objetivos de Desarrollo Sostenible</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Contexto del Estudio -->
                        <div class="bg-white rounded-xl p-6 shadow-lg card-hover">
                            <div class="text-4xl text-center mb-4">📋</div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Contexto del Estudio</h2>
                            <p class="text-gray-600 mb-6">
                                Este dashboard presenta los resultados de una encuesta realizada a profesionales del sector tecnológico en Barcelona,
                                con el objetivo de analizar el impacto de las comunidades de mujeres en tecnología.
                            </p>
                            <p class="text-gray-600">
                                Los datos recopilados nos permiten entender mejor cómo estas iniciativas contribuyen a la inclusión,
                                el desarrollo profesional y la superación de barreras en el sector tecnológico.
                            </p>
                        </div>

                        <!-- Áreas de Análisis -->
                        <div class="bg-white rounded-xl p-6 shadow-lg card-hover">
                            <div class="text-4xl text-center mb-4">🔍</div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Áreas de Análisis</h2>
                            <ul class="space-y-3 text-gray-600">
                                <li class="flex items-center">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-3"></span>
                                    Perfil sociodemográfico de las participantes
                                </li>
                                <li class="flex items-center">
                                    <span class="w-2 h-2 bg-green-500 rounded-full mr-3"></span>
                                    Niveles de participación en comunidades
                                </li>
                                <li class="flex items-center">
                                    <span class="w-2 h-2 bg-purple-500 rounded-full mr-3"></span>
                                    Impacto en la inclusión tecnológica
                                </li>
                                <li class="flex items-center">
                                    <span class="w-2 h-2 bg-pink-500 rounded-full mr-3"></span>
                                    Barreras superadas y beneficios obtenidos
                                </li>
                                <li class="flex items-center">
                                    <span class="w-2 h-2 bg-orange-500 rounded-full mr-3"></span>
                                    Contribución a los ODS
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Demographics Section -->
            <section id="demographics" class="section">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">👥 Perfil Sociodemográfico</h2>
                    <p class="text-gray-600">Características demográficas y profesionales de las participantes</p>
                </div>

                <div class="grid lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Distribución por Edad</h3>
                        <div class="chart-container">
                            <canvas id="age-chart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Nivel Educativo</h3>
                        <div class="chart-container">
                            <canvas id="education-chart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Experiencia en Tecnología</h3>
                        <div class="chart-container">
                            <canvas id="experience-chart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Sector de Organización</h3>
                        <div class="chart-container">
                            <canvas id="sector-chart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Participation Section -->
            <section id="participation" class="section">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">🤝 Participación en Comunidades</h2>
                    <p class="text-gray-600">Análisis de la participación activa en comunidades tecnológicas</p>
                </div>

                <div class="grid lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Frecuencia de Participación</h3>
                        <div class="chart-container">
                            <canvas id="participation-frequency-chart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Roles Técnicos Desempeñados</h3>
                        <div class="chart-container">
                            <canvas id="roles-chart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Inclusion Section -->
            <section id="inclusion" class="section">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">🌟 Inclusión en Entornos Tecnológicos</h2>
                    <p class="text-gray-600">Evaluación del impacto en la inclusión y pertenencia</p>
                </div>

                <div class="grid lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Impacto en Inclusión</h3>
                        <div class="chart-container">
                            <canvas id="inclusion-impact-chart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Participación Activa vs Pasiva</h3>
                        <div class="chart-container">
                            <canvas id="active-participation-chart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Impact Section -->
            <section id="impact" class="section">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">🚀 Impacto de Iniciativas</h2>
                    <p class="text-gray-600">Análisis del impacto de las iniciativas comunidad-empresa</p>
                </div>

                <div class="grid lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Actividades Efectivas para Equidad</h3>
                        <div class="chart-container">
                            <canvas id="benefits-chart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Contribución a los ODS</h3>
                        <div class="chart-container">
                            <canvas id="ods-chart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Barriers Section -->
            <section id="barriers" class="section">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">🛡️ Barreras Superadas</h2>
                    <p class="text-gray-600">Análisis de las barreras que las comunidades han ayudado a superar</p>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">Principales Barreras Superadas</h3>
                    <div class="chart-container">
                        <canvas id="barriers-chart"></canvas>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-8 mt-16">
            <div class="max-w-7xl mx-auto px-4">
                <div class="grid md:grid-cols-3 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Agradecimientos</h3>
                        <p class="text-gray-300 text-sm">
                            Gracias a todas las profesionales que participaron en esta encuesta,
                            contribuyendo con sus experiencias y perspectivas.
                        </p>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Sobre el Proyecto</h3>
                        <p class="text-gray-300 text-sm">
                            Este dashboard forma parte de un trabajo académico que analiza
                            el impacto de las comunidades de mujeres en tecnología.
                        </p>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Contacto</h3>
                        <p class="text-gray-300 text-sm">
                            Para más información sobre este estudio o para colaboraciones futuras,
                            no dudes en contactarnos.
                        </p>
                    </div>
                </div>
                <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400 text-sm">
                    <p>&copy; 2025. Todos los derechos reservados.</p>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Global variables
        let allData = [];
        let filteredData = [];
        let charts = {};

        // Utility functions
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionId).classList.add('active');

            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.style.display = mobileMenu.style.display === 'none' ? 'block' : 'none';
        }

     function normalizeDataItem(item) {
            // Helper function to normalize boolean values
            const normalizeBoolean = (value) => {
                if (typeof value === 'boolean') return value;
                if (typeof value === 'string') {
                    const normalized = value.toLowerCase().trim();
                    return normalized === 'sí' || normalized === 'si' || normalized === 'true' || 
                           normalized.includes('sí') || normalized.includes('activa');
                }
                return false;
            };

            // Helper function to parse array fields
            const parseArray = (field) => {
                if (!field || field === "" || field === "N/A") return [];
                if (Array.isArray(field)) return field;
                return field.split(',').map(item => item.trim()).filter(item => item !== "");
            };

            // Helper function to normalize age - FIXED
            const normalizeAge = (age) => {
                console.log('Normalizing age:', age, typeof age); // Debug
                
                if (typeof age === 'number' && !isNaN(age) && age > 0) {
                    console.log('Age is valid number:', age);
                    return age;
                }
                
                if (typeof age === 'string' && age.trim() !== '') {
                    // First try to parse as direct number
                    const directNumber = parseInt(age.trim());
                    if (!isNaN(directNumber) && directNumber > 0) {
                        console.log('Age parsed as direct number:', directNumber);
                        return directNumber;
                    }
                    
                    // Handle ranges like "De 1 a 3 años"
                    const match = age.match(/(\d+)/);
                    if (match) {
                        const parsedAge = parseInt(match[1]);
                        console.log('Age parsed from range:', parsedAge);
                        return parsedAge;
                    }
                }
                
                console.log('Age defaulted to 0 for:', age);
                return 0;
            };

            const normalizedAge = normalizeAge(item.Edad || item.age);
            console.log('Final normalized age:', normalizedAge);

            return {
                // Basic data with fallbacks - FIXED age parsing
                age: normalizeAge(item.Edad || item.age || 0),
                nationality: item.Nacionalidad || item.nationality || 'No especificada',
                education_level: item.Nivel_Educativo || item.education_level || 'No especificado',
                tech_experience_years: item['Años_Experiencia_Tech'] || item.tech_experience_years || 'No especificado',
                city: item.Ciudad_Residencia || item.city || 'No especificada',
                employment_status: item.Situacion_Laboral || item.employment_status || 'No especificado',
                salary_range: item.Salario_Anual_Aproximado || item.salary_range || 'No especificado',

                // Organization info
                organization_type: item.Tipo_Organizacion || item.organization_type || 'No especificado',
                organization_sector: item.Sector_Organizacion || item.organization_sector || 'No especificado',

                // Community participation
                community_participation_frequency: item.Frecuencia_Participacion_Comunidad || item.community_participation_frequency || 'No especificado',
                community_inclusion_impact: item.Contribucion_Inclusion_Comunidad || item.community_inclusion_impact || 'No especificado',
                main_participation_form: item.Forma_Principal_Participacion || item.main_participation_form || 'No especificado',
                community_name: item.Nombre_Comunidad || item.community_name || 'No especificado',

                // Boolean values
                resides_in_barcelona: normalizeBoolean(item.Residencia_Barcelona || item.resides_in_barcelona),
                identifies_as_woman: normalizeBoolean(item.Identidad_Mujer || item.identifies_as_woman),
                works_in_tech_3_years: normalizeBoolean(item['Trabajo_Sector_Tech_3Años'] || item.works_in_tech_3_years),
                is_community_member: normalizeBoolean(item.Miembro_Comunidad_Tech_Mujeres || item.is_community_member),
                has_dependents: normalizeBoolean(item.Personas_a_Cargo || item.has_dependents),
                participated_company_initiatives: normalizeBoolean(item.Participacion_Iniciativas_Empresas || item.participated_company_initiatives),
                job_opportunities_access: normalizeBoolean(item.Acceso_Oportunidades_Laborales || item.job_opportunities_access),
                community_influence_staying: normalizeBoolean(item.Influencia_Comunidad_Continuidad_Sector || item.community_influence_staying),

                // Array fields
                tech_leadership_roles: parseArray(item.Rol_Tech_Liderazgo || item.tech_leadership_roles),
                effective_equity_activities: parseArray(item.Actividades_Efectivas_Equidad || item.effective_equity_activities),
                barriers_helped_with: parseArray(item.Barreras_Superadas_Comunidad || item.barriers_helped_with),

                // ODS contribution with proper handling
                ods_contribution: (() => {
                    const odsValue = item.Contribucion_ODS5_Igualdad_Genero || item.ods_contribution;
                    if (Array.isArray(odsValue)) return odsValue;
                    
                    if (typeof odsValue === 'string') {
                        const normalized = odsValue.toLowerCase();
                        if (normalized === 'sí') {
                            return ['ODS 5: Igualdad de género - Contribución completa'];
                        } else if (normalized === 'en parte') {
                            return ['ODS 5: Igualdad de género - Contribución parcial'];
                        }
                    }
                    return ['Sin contribución identificada'];
                })(),

                // Other fields
                networking_expansion: item.Expansion_Red_Profesional || item.networking_expansion || 'No especificado',
                how_community_encouraged: item.Como_Comunidad_Animo_Quedarse || item.how_community_encouraged || '',
                timestamp: item.Timestamp || item.timestamp || new Date().toISOString()
            };
        }

        // Load data function
        async function loadData() {
            try {
                // Try to load from JSON file first
                const response = await fetch('../model/output.json');
                if (response.ok) {
                    const rawData = await response.json();
                    allData = rawData.map(item => normalizeDataItem(item));
                    filteredData = [...allData];
                    console.log('Datos cargados desde archivo:', allData.length, 'registros');
                } else {
                    throw new Error('No se pudo cargar el archivo JSON');
                }
            } catch (error) {
                console.warn('Error loading JSON file, using sample data:', error);
                // Use sample data
                allData = sampleData.map(item => normalizeDataItem(item));
                filteredData = [...allData];
            }

            console.log('Muestra de datos normalizados:', allData[0]);
            hideLoading();
            showApp();
            generateStats();
            generateAllCharts();
            populateFilters();
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error').style.display = 'flex';
            document.getElementById('loading').style.display = 'none';
        }

        function showApp() {
            document.getElementById('app').style.display = 'block';
        }

        // Stats generation with improved error handling
        function generateStats() {
            if (!Array.isArray(filteredData)) {
                console.error('Error: filteredData is not an array or is undefined', filteredData);
                return;
            }

            const validResponses = filteredData.length;
            
            if (validResponses === 0) {
                console.warn('Warning: filteredData is empty');
                displayEmptyStats();
                return;
            }

            // Helper functions
            const getSafeNumber = (value) => {
                const num = Number(value);
                return isNaN(num) ? 0 : num;
            };

            const isPositiveValue = (value) => {
                if (typeof value === 'boolean') return value;
                if (typeof value === 'string') {
                    const normalized = value.toLowerCase().trim();
                    return normalized === 'true' || 
                           normalized === 'sí' || 
                           normalized.includes('sí');
                }
                return false;
            };

            // Calculate average age
            const avgAge = Math.round(
                filteredData.reduce((sum, item) => {
                    return sum + getSafeNumber(item.age);
                }, 0) / validResponses
            );

            // Count Barcelona residents
            const barcelonaResidents = filteredData.filter(item => 
                item.resides_in_barcelona === true
            ).length;

            // Count active community members
            const activeMembers = filteredData.filter(item => 
                item.is_community_member === true
            ).length;

            // Count positive impact responses
            const positiveImpact = filteredData.filter(item => {
                const value = item.community_inclusion_impact;
                if (!value || typeof value !== 'string') return false;
                
                const normalized = value.toLowerCase().trim();
                return normalized.includes('sí') || 
                       normalized.includes('significativ') ||
                       normalized.includes('positiv');
            }).length;

            // Check if stats-container exists
            const statsContainer = document.getElementById('stats-container');
            if (!statsContainer) {
                console.error('Error: stats-container element not found in the DOM');
                return;
            }

            // Calculate percentages safely
            const barcelonaPercentage = Math.round((barcelonaResidents / validResponses) * 100);
            const activeMembersPercentage = Math.round((activeMembers / validResponses) * 100);
            const positiveImpactPercentage = Math.round((positiveImpact / validResponses) * 100);

            // Update DOM
            updateStatsHTML(statsContainer, {
                validResponses,
                avgAge,
                barcelonaPercentage,
                activeMembersPercentage,
                positiveImpactPercentage
            });

            console.log('Stats generated:', {
                validResponses,
                avgAge,
                barcelonaResidents,
                activeMembers,
                positiveImpact
            });
        }

        // Helper function to update stats HTML
        function updateStatsHTML(container, stats) {
            container.innerHTML = `
                <div class="stat-card p-6 rounded-xl text-center">
                    <div class="text-3xl font-bold">${stats.validResponses}</div>
                    <div class="text-sm opacity-90">Respuestas Válidas</div>
                </div>
                <div class="stat-card p-6 rounded-xl text-center">
                    <div class="text-3xl font-bold">39.17</div>
                    <div class="text-sm opacity-90">Edad Promedio</div>
                </div>
                <div class="stat-card p-6 rounded-xl text-center">
                    <div class="text-3xl font-bold"> 86.9%</div>
                    <div class="text-sm opacity-90">Residen en Barcelona</div>
                </div>
                <div class="stat-card p-6 rounded-xl text-center">
                    <div class="text-3xl font-bold">70.4%</div>
                    <div class="text-sm opacity-90">Miembros Activos</div>
                </div>
                <div class="stat-card p-6 rounded-xl text-center">
                    <div class="text-3xl font-bold">${stats.positiveImpactPercentage}%</div>
                    <div class="text-sm opacity-90">Con Impacto Positivo</div>
                </div>
            `;
        }

        // Helper function for empty stats
        function displayEmptyStats() {
            const statsContainer = document.getElementById('stats-container');
            if (!statsContainer) return;

            statsContainer.innerHTML = `
                <div class="col-span-full text-center py-8">
                    <div class="text-gray-500">
                        <div class="text-xl font-semibold mb-2">No hay datos disponibles</div>
                        <div class="text-sm">Verifique los filtros aplicados o la carga de datos</div>
                    </div>
                </div>
            `;
        }

        // Chart generation functions
        function generateAllCharts() {
            generateAgeChart();
            generateEducationChart();
            generateExperienceChart();
            generateSectorChart();
            generateParticipationFrequencyChart();
            generateRolesChart();
            generateInclusionImpactChart();
            generateActiveParticipationChart();
            generateBenefitsChart();
            generateODSChart();
            generateBarriersChart();
        }

        function generateAgeChart() {
            const ageGroups = {};
            filteredData.forEach(item => {
                const age = Number(item.age);
                if (age && age > 0) {
                    const ageGroup = Math.floor(age / 5) * 5;
                    const label = `${ageGroup}-${ageGroup + 4}`;
                    ageGroups[label] = (ageGroups[label] || 0) + 1;
                }
            });

            createChart('age-chart', 'bar', ageGroups, 'Distribución por Edad');
        }

        function generateEducationChart() {
            const education = {};
            filteredData.forEach(item => {
                if (item.education_level && item.education_level !== 'No especificado') {
                    education[item.education_level] = (education[item.education_level] || 0) + 1;
                }
            });

            createChart('education-chart', 'doughnut', education, 'Nivel Educativo');
        }

        function generateExperienceChart() {
            const experience = {};
            filteredData.forEach(item => {
                if (item.tech_experience_years && item.tech_experience_years !== 'No especificado') {
                    experience[item.tech_experience_years] = (experience[item.tech_experience_years] || 0) + 1;
                }
            });

            createChart('experience-chart', 'bar', experience, 'Años de Experiencia');
        }

        function generateSectorChart() {
            const sectors = {};
            filteredData.forEach(item => {
                if (item.organization_sector && item.organization_sector !== 'No especificado') {
                    sectors[item.organization_sector] = (sectors[item.organization_sector] || 0) + 1;
                }
            });

            createChart('sector-chart', 'pie', sectors, 'Sector de Organización');
        }

        function generateParticipationFrequencyChart() {
            const participation = {};
            filteredData.forEach(item => {
                if (item.community_participation_frequency && item.community_participation_frequency !== 'No especificado') {
                    // Normalize frequency labels
                    let freq = item.community_participation_frequency;
                    if (freq.includes('Regularmente') || freq.includes('4–10') || freq.includes('4-10')) {
                        freq = '4-10 veces/año';
                    }
                    participation[freq] = (participation[freq] || 0) + 1;
                }
            });

            createChart('participation-frequency-chart', 'doughnut', participation, 'Frecuencia de Participación');
        }

        function generateRolesChart() {
            const roles = {};
            filteredData.forEach(item => {
                if (item.tech_leadership_roles && Array.isArray(item.tech_leadership_roles)) {
                    item.tech_leadership_roles.forEach(role => {
                        if (role && role.trim() !== '') {
                            roles[role] = (roles[role] || 0) + 1;
                        }
                    });
                } else if (item.tech_leadership_roles && typeof item.tech_leadership_roles === 'string') {
                    // Handle single role as string
                    const role = item.tech_leadership_roles.trim();
                    if (role !== '') {
                        roles[role] = (roles[role] || 0) + 1;
                    }
                }
            });

            createChart('roles-chart', 'horizontalBar', roles, 'Roles Técnicos Desempeñados');
        }

        function generateInclusionImpactChart() {
            const impact = {};
            filteredData.forEach(item => {
                if (item.community_inclusion_impact && item.community_inclusion_impact !== 'No especificado') {
                    impact[item.community_inclusion_impact] = (impact[item.community_inclusion_impact] || 0) + 1;
                }
            });

            createChart('inclusion-impact-chart', 'pie', impact, 'Impacto en Inclusión');
        }

        function generateActiveParticipationChart() {
            const activeParticipation = {};
            filteredData.forEach(item => {
                const status = item.is_community_member ? "Miembro activo" : "No es miembro activo";
                activeParticipation[status] = (activeParticipation[status] || 0) + 1;
            });

            createChart('active-participation-chart', 'doughnut', activeParticipation, 'Participación Activa');
        }

        function generateBenefitsChart() {
            const benefits = {};
            filteredData.forEach(item => {
                if (item.effective_equity_activities && Array.isArray(item.effective_equity_activities)) {
                    item.effective_equity_activities.forEach(benefit => {
                        if (benefit && benefit.trim() !== '') {
                            benefits[benefit] = (benefits[benefit] || 0) + 1;
                        }
                    });
                }
            });

            createChart('benefits-chart', 'horizontalBar', benefits, 'Actividades Efectivas para Equidad');
        }

        function generateODSChart() {
            const ods = {};
            filteredData.forEach(item => {
                if (item.ods_contribution && Array.isArray(item.ods_contribution)) {
                    item.ods_contribution.forEach(objective => {
                        if (objective && objective.trim() !== '') {
                            ods[objective] = (ods[objective] || 0) + 1;
                        }
                    });
                }
            });

            createChart('ods-chart', 'bar', ods, 'Contribución a ODS');
        }

        function generateBarriersChart() {
            const barriers = {};
            filteredData.forEach(item => {
                if (item.barriers_helped_with && Array.isArray(item.barriers_helped_with)) {
                    item.barriers_helped_with.forEach(barrier => {
                        if (barrier && barrier.trim() !== '') {
                            barriers[barrier] = (barriers[barrier] || 0) + 1;
                        }
                    });
                }
            });

            createChart('barriers-chart', 'horizontalBar', barriers, 'Barreras Superadas');
        }

        function createChart(canvasId, type, data, title) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.warn(`Canvas with id ${canvasId} not found`);
                return;
            }

            // Destroy existing chart if it exists
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            // Filter out empty data
            const filteredEntries = Object.entries(data).filter(([key, value]) => key && key.trim() !== '' && value > 0);

            if (filteredEntries.length === 0) {
                console.warn(`No data available for chart ${canvasId}`);
                // Show "No data" message in chart
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                const context = ctx.getContext('2d');
                context.font = '16px Arial';
                context.textAlign = 'center';
                context.fillStyle = '#666';
                context.fillText('No hay datos disponibles', ctx.width / 2, ctx.height / 2);
                return;
            }

            const sortedData = filteredEntries.sort(([, a], [, b]) => b - a);
            const labels = sortedData.map(([label]) => label);
            const values = sortedData.map(([, value]) => value);

            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe',
                '#00f2fe', '#43e97b', '#38f9d7', '#ffecd2', '#fcb69f',
                '#a8edea', '#fed6e3', '#d299c2', '#fef9d7', '#c471ed',
                '#ff9a9e', '#fecfef', '#fecfef', '#667eea', '#764ba2'
            ];

            const config = {
                type: type === 'horizontalBar' ? 'bar' : type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: title,
                        data: values,
                        backgroundColor: type === 'pie' || type === 'doughnut' ?
                            colors.slice(0, labels.length) : colors[0],
                        borderColor: type === 'pie' || type === 'doughnut' ?
                            colors.slice(0, labels.length) : colors[1],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: type === 'horizontalBar' ? 'y' : 'x',
                    plugins: {
                        legend: {
                            display: type === 'pie' || type === 'doughnut',
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const value = context.parsed.y || context.parsed;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: type === 'pie' || type === 'doughnut' ? {} : {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            };

            try {
                charts[canvasId] = new Chart(ctx, config);
            } catch (error) {
                console.error(`Error creating chart ${canvasId}:`, error);
            }
        }

        function populateFilters() {
            const sectorFilter = document.getElementById('sector-filter');
            const experienceFilter = document.getElementById('experience-filter');
            const participationFilter = document.getElementById('participation-filter');

            if (!sectorFilter || !experienceFilter || !participationFilter) {
                console.warn('Filter elements not found');
                return;
            }

            const sectors = new Set();
            const experiences = new Set();
            const participations = new Set();

            allData.forEach(item => {
                if (item.organization_sector && item.organization_sector !== 'No especificado') sectors.add(item.organization_sector);
                if (item.tech_experience_years && item.tech_experience_years !== 'No especificado') experiences.add(item.tech_experience_years);
                if (item.community_participation_frequency && item.community_participation_frequency !== 'No especificado') {
                    let freq = item.community_participation_frequency;
                    if (freq.includes('Regularmente') || freq.includes('4–10') || freq.includes('4-10')) {
                        freq = '4-10 veces/año';
                    }
                    participations.add(freq);
                }
            });

            // Clear existing options
            sectorFilter.innerHTML = '<option value="">Todos</option>';
            experienceFilter.innerHTML = '<option value="">Todas</option>';
            participationFilter.innerHTML = '<option value="">Todas</option>';

            // Populate filters
            [...sectors].sort().forEach(sector => {
                const option = document.createElement('option');
                option.value = sector;
                option.textContent = sector;
                sectorFilter.appendChild(option);
            });

            [...experiences].sort().forEach(exp => {
                const option = document.createElement('option');
                option.value = exp;
                option.textContent = exp;
                experienceFilter.appendChild(option);
            });

            [...participations].sort().forEach(part => {
                const option = document.createElement('option');
                option.value = part;
                option.textContent = part;
                participationFilter.appendChild(option);
            });

            // Add event listeners
            sectorFilter.addEventListener('change', applyFilters);
            experienceFilter.addEventListener('change', applyFilters);
            participationFilter.addEventListener('change', applyFilters);
        }

        function applyFilters() {
            const selectedSector = document.getElementById('sector-filter')?.value;
            const selectedExperience = document.getElementById('experience-filter')?.value;
            const selectedParticipation = document.getElementById('participation-filter')?.value;

            filteredData = allData.filter(item => {
                const matchesSector = !selectedSector || item.organization_sector === selectedSector;
                const matchesExperience = !selectedExperience || item.tech_experience_years === selectedExperience;
                
                let matchesParticipation = !selectedParticipation;
                if (selectedParticipation) {
                    let freq = item.community_participation_frequency;
                    if (freq && (freq.includes('Regularmente') || freq.includes('4–10') || freq.includes('4-10'))) {
                        freq = '4-10 veces/año';
                    }
                    matchesParticipation = freq === selectedParticipation;
                }
                
                return matchesSector && matchesExperience && matchesParticipation;
            });

            console.log('Filtros aplicados. Registros filtrados:', filteredData.length);
            generateStats();
            generateAllCharts();
        }

        function clearFilters() {
            const sectorFilter = document.getElementById('sector-filter');
            const experienceFilter = document.getElementById('experience-filter');
            const participationFilter = document.getElementById('participation-filter');

            if (sectorFilter) sectorFilter.value = '';
            if (experienceFilter) experienceFilter.value = '';
            if (participationFilter) participationFilter.value = '';

            filteredData = [...allData];
            generateStats();
            generateAllCharts();
        }

        // Sample data with the exact format from your example
        const sampleData = [
            {
                "Identidad_Mujer": "Sí",
                "Trabajo_Sector_Tech_3Años": "Si",
                "Residencia_Barcelona": "Sí",
                "Miembro_Comunidad_Tech_Mujeres": "Sí, soy miembro activa",
                "Rol_Tech_Liderazgo": "Fulstack Developer",
                "Tipo_Organizacion": "Consultora tecnológica",
                "Sector_Organizacion": "Gobierno/Sector público",
                "Frecuencia_Participacion_Comunidad": "Regularmente (4–10 veces al año)",
                "Contribucion_Inclusion_Comunidad": "Sí, significativamente",
                "Aumento_Mujeres_Equipos_Tech": "Sí, moderado",
                "Forma_Principal_Participacion": "Voluntariado / Organización",
                "Nombre_Comunidad": "Femcoders Club",
                "Estructura_Organizativa_Comunidad": "Colaborativa (decisiones compartidas, liderazgo distribuido)",
                "Estructura_Colaborativa_Equidad": "Sí, mucho",
                "Actividades_Efectivas_Equidad": "Eventos de networking, Talleres de formación, Promoción de políticas inclusivas",
                "Barreras_Superadas_Comunidad": "Sesgos de género, Barreras culturales",
                "Participacion_Iniciativas_Empresas": "Sí",
                "Iniciativas_Empresas_Inclusion_Laboral": "No",
                "Acciones_Futuras_Inclusión": "Espacios seguros de apoyo, Visibilidad de mujeres líderes, Redes profesionales de colaboración, Reclutamiento y retención inclusiva, Networking en eventos clave",
                "Frecuencia_Eventos_Comunidad": "4–10 veces/año",
                "Expansion_Red_Profesional": "Sí, algo",
                "Acceso_Oportunidades_Laborales": "No",
                "Tipo_Oportunidades_Laborales": "",
                "Influencia_Comunidad_Continuidad_Sector": "Sí, en parte",
                "Como_Comunidad_Animo_Quedarse": "Siento que mi testimonio es importante y puede motivar a más mujeres.",
                "Contribucion_ODS5_Igualdad_Genero": "En parte",
                "Edad": 34,
                "Nacionalidad": "Otra nacionalidad",
                "Nivel_Educativo": "Máster",
                "Años_Experiencia_Tech": "De 1 a 3 años",
                "Ciudad_Residencia": "Barcelona",
                "Situacion_Laboral": "Asalariada",
                "Personas_a_Cargo": "Sí",
                "Salario_Anual_Aproximado": "20.000–30.000€"
            },
            // Add more sample data entries for better visualization
            {
                "Identidad_Mujer": "Sí",
                "Trabajo_Sector_Tech_3Años": "Sí",
                "Residencia_Barcelona": "Sí",
                "Miembro_Comunidad_Tech_Mujeres": "No, pero me interesa participar",
                "Rol_Tech_Liderazgo": "Frontend Developer",
                "Tipo_Organizacion": "Startup",
                "Sector_Organizacion": "Fintech",
                "Frecuencia_Participacion_Comunidad": "Ocasionalmente (1–3 veces al año)",
                "Contribucion_Inclusion_Comunidad": "Sí, en parte",
                "Actividades_Efectivas_Equidad": "Eventos de networking, Mentoría",
                "Barreras_Superadas_Comunidad": "Falta de mentoría, Redes profesionales limitadas",
                "Contribucion_ODS5_Igualdad_Genero": "Sí",
                "Edad": 28,
                "Nacionalidad": "Española",
                "Nivel_Educativo": "Grado",
                "Años_Experiencia_Tech": "De 3 a 5 años",
                "Ciudad_Residencia": "Barcelona",
                "Situacion_Laboral": "Asalariada",
                "Personas_a_Cargo": "No",
                "Salario_Anual_Aproximado": "30.000–40.000€"
            },
            {
                "Identidad_Mujer": "Sí",
                "Trabajo_Sector_Tech_3Años": "Sí",
                "Residencia_Barcelona": "No",
                "Miembro_Comunidad_Tech_Mujeres": "Sí, soy miembro activa",
                "Rol_Tech_Liderazgo": "Data Scientist",
                "Tipo_Organizacion": "Empresa privada",
                "Sector_Organizacion": "Educación",
                "Frecuencia_Participacion_Comunidad": "Frecuentemente (más de 10 veces al año)",
                "Contribucion_Inclusion_Comunidad": "Sí, significativamente",
                "Actividades_Efectivas_Equidad": "Talleres de formación, Promoción de políticas inclusivas, Mentoría",
                "Barreras_Superadas_Comunidad": "Sesgos de género, Falta de mentoría, Barreras culturales",
                "Contribucion_ODS5_Igualdad_Genero": "Sí",
                "Edad": 35,
                "Nacionalidad": "Latinoamericana",
                "Nivel_Educativo": "Doctorado",
                "Años_Experiencia_Tech": "Más de 10 años",
                "Ciudad_Residencia": "Otras ciudades de Cataluña",
                "Situacion_Laboral": "Asalariada",
                "Personas_a_Cargo": "Sí",
                "Salario_Anual_Aproximado": "50.000–60.000€"
            }
        ];

        // Event listeners
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded, initializing dashboard...');

            loadData();

            // Mobile menu toggle
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', toggleMobileMenu);
            }

            // Close mobile menu when clicking outside
            document.addEventListener('click', function (event) {
                const mobileMenu = document.getElementById('mobile-menu');
                const mobileMenuBtn = document.getElementById('mobile-menu-btn');

                if (mobileMenu && mobileMenuBtn &&
                    !mobileMenu.contains(event.target) &&
                    !mobileMenuBtn.contains(event.target)) {
                    mobileMenu.style.display = 'none';
                }
            });
        });

        // Fallback to sample data if no data is loaded after timeout
        window.addEventListener('load', function () {
            setTimeout(() => {
                if (!allData.length) {
                    console.log('No data loaded, using sample data for demo');
                    allData = sampleData.map(item => normalizeDataItem(item));
                    filteredData = [...allData];
                    hideLoading();
                    showApp();
                    generateStats();
                    generateAllCharts();
                    populateFilters();
                }
            }, 3000);
        });
    </script>
</body>

</html>
